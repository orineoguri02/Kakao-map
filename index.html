<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>카카오맵 WebView 연동</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      let map;
      let volunteerMarkers = [];
      let selectedMarker = null;

      function initMap(lat = 35.1796, lng = 129.0756, zoom = 8) {
        if (typeof kakao === "undefined" || !kakao.maps) {
          console.error("카카오 객체 없음. 도메인/키 설정을 확인해라.");
          return;
        }

        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(lat, lng),
          level: zoom,
        };
        map = new kakao.maps.Map(container, options);

        sendToRN({ type: "map_loaded" });
      }

      function clearMarkers(arr) {
        arr.forEach((m) => m.setMap(null));
        arr.length = 0;
      }

      function waitForKakaoAndInit() {
        const maxTries = 30;
        let tries = 0;

        const iv = setInterval(() => {
          if (typeof kakao !== "undefined" && kakao.maps) {
            clearInterval(iv);
            initMap();
          } else if (++tries >= maxTries) {
            clearInterval(iv);
            console.error("카카오맵 SDK 로드 실패");
          }
        }, 200);
      }

      function sendToRN(payload) {
        if (
          window.ReactNativeWebView &&
          window.ReactNativeWebView.postMessage
        ) {
          window.ReactNativeWebView.postMessage(JSON.stringify(payload));
        } else {
          window.parent.postMessage(JSON.stringify(payload), "*");
        }
      }

      function handleMessageEvent(e) {
        try {
          const msg = JSON.parse(e.data);

          if (!map) {
            console.warn("지도가 아직 준비되지 않음");
            return;
          }

          if (msg.type === "setVolunteerLocations") {
            // 기존 봉사 마커 제거
            clearMarkers(volunteerMarkers);

            // 새 마커 생성
            msg.locations.forEach((loc) => {
              const position = new kakao.maps.LatLng(loc.lat, loc.lng);
              const marker = new kakao.maps.Marker({
                position: position,
                map: map,
                title: loc.name,
              });

              // 마커 클릭 이벤트
              kakao.maps.event.addListener(marker, "click", function () {
                sendToRN({
                  type: "location_selected",
                  location: loc,
                });
              });

              volunteerMarkers.push(marker);
            });
          }

          if (msg.type === "setLocation") {
            // 기존 선택 마커 제거
            if (selectedMarker) {
              selectedMarker.setMap(null);
            }

            // 새 선택 마커 생성
            const position = new kakao.maps.LatLng(msg.lat, msg.lng);
            selectedMarker = new kakao.maps.Marker({
              position: position,
              map: map,
            });

            // 지도 중심 이동
            map.setCenter(position);
            if (msg.zoom != null) {
              map.setLevel(msg.zoom);
            }
          }

          if (msg.type === "searchKeyword") {
            const ps = new kakao.maps.services.Places();
            ps.keywordSearch(msg.keyword, (data, status) => {
              if (status === kakao.maps.services.Status.OK) {
                const first = data[0];
                map.setCenter(new kakao.maps.LatLng(first.y, first.x));
                new kakao.maps.Marker({
                  position: new kakao.maps.LatLng(first.y, first.x),
                  map: map,
                });
                sendToRN({
                  type: "searchResult",
                  name: first.place_name,
                  address: first.address_name,
                  location: { lat: first.y, lng: first.x },
                });
              } else {
                sendToRN({ type: "searchResult", error: status });
              }
            });
          }
        } catch (err) {
          console.warn("메시지 파싱 실패", err);
        }
      }

      window.addEventListener("load", () => {
        waitForKakaoAndInit();
        window.addEventListener("message", handleMessageEvent);
      });
    </script>

    <!-- 카카오맵 JS 키 -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=14c064ab4043e357b8a6246384ef402a&libraries=services,clusterer"></script>
  </body>
</html>
