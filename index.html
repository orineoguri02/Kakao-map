<script>
  let map;
  const statusEl = document.getElementById("status");

  function initMap(lat = 37.5665, lng = 126.978) {
    if (typeof kakao === "undefined" || !kakao.maps) {
      statusEl.textContent = "카카오 SDK 로드 실패 or 제한됨";
      console.error("kakao 객체 없음, 도메인 제한/키 확인 필요");
      return;
    }

    const container = document.getElementById("map");
    const options = {
      center: new kakao.maps.LatLng(lat, lng),
      level: 4,
    };
    map = new kakao.maps.Map(container, options);

    const marker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(lat, lng),
    });
    marker.setMap(map);
    statusEl.textContent = `현재 중심: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  }

  function waitForKakaoAndInit() {
    const maxTries = 20;
    let tries = 0;
    const iv = setInterval(() => {
      if (typeof kakao !== "undefined" && kakao.maps) {
        clearInterval(iv);
        initMap();
      } else if (++tries >= maxTries) {
        clearInterval(iv);
        statusEl.textContent = "카카오맵 SDK 로드 실패 (도메인/키 확인)";
        console.error("카카오맵 SDK를 못 불러옴. 도메인 제한 또는 키 문제.");
      }
    }, 250);
  }

  window.onload = () => {
    waitForKakaoAndInit();

    window.addEventListener("message", (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === "setLocation") {
          initMap(msg.lat, msg.lng);
        } else if (msg.type === "searchKeyword") {
          if (!map) return;
          const ps = new kakao.maps.services.Places();
          ps.keywordSearch(msg.keyword, (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
              const first = data[0];
              map.setCenter(new kakao.maps.LatLng(first.y, first.x));
              new kakao.maps.Marker({
                position: new kakao.maps.LatLng(first.y, first.x),
                map: map,
              });
              sendToRN({
                type: "searchResult",
                name: first.place_name,
                address: first.address_name,
              });
            } else {
              sendToRN({ type: "searchResult", error: status });
            }
          });
        }
      } catch (err) {
        console.warn("파싱 실패", err);
      }
    });
  };

  function sendToRN(payload) {
    if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
      window.ReactNativeWebView.postMessage(JSON.stringify(payload));
    } else {
      window.parent.postMessage(JSON.stringify(payload), "*");
    }
  }
</script>
