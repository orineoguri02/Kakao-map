<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>카카오맵 WebView 연동</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
      .overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
        z-index: 10;
      }
      .error {
        color: #b00;
      }
    </style>
    <!-- 카카오맵 JS 키 -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=14c064ab4043e357b8a6246384ef402a&libraries=services,clusterer"></script>
  </head>
  <body>
    <div id="map"></div>
    <div class="overlay" id="status">로딩 중...</div>

    <script>
      let map;

      function getStatusEl() {
        return document.getElementById("status");
      }

      function setStatus(text, isError = false) {
        const el = getStatusEl();
        if (el) {
          el.textContent = text;
          if (isError) el.classList.add("error");
          else el.classList.remove("error");
        }
        console.log("[KakaoMapStatus]", text);
      }

      function initMap(lat = 37.5665, lng = 126.978) {
        if (typeof kakao === "undefined" || !kakao.maps) {
          setStatus(
            "카카오맵 SDK 로드 실패. 도메인 제한 또는 키 확인 필요.",
            true
          );
          console.error("카카오 객체 없음. 도메인/키 설정을 확인해라.");
          return;
        }

        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(lat, lng),
          level: 4,
        };
        map = new kakao.maps.Map(container, options);

        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(lat, lng),
        });
        marker.setMap(map);
        setStatus(`현재 중심: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
      }

      function waitForKakaoAndInit() {
        const maxTries = 20;
        let tries = 0;
        const iv = setInterval(() => {
          if (typeof kakao !== "undefined" && kakao.maps) {
            clearInterval(iv);
            initMap();
          } else if (++tries >= maxTries) {
            clearInterval(iv);
            setStatus(
              "카카오맵 SDK를 못 불러왔습니다. Web 플랫폼 도메인 / 키 확인하세요.",
              true
            );
          }
        }, 250);
      }

      function sendToRN(payload) {
        if (
          window.ReactNativeWebView &&
          window.ReactNativeWebView.postMessage
        ) {
          window.ReactNativeWebView.postMessage(JSON.stringify(payload));
        } else {
          window.parent.postMessage(JSON.stringify(payload), "*");
        }
      }

      function handleMessageEvent(e) {
        try {
          const msg = JSON.parse(e.data);
          if (msg.type === "setLocation") {
            initMap(msg.lat, msg.lng);
          } else if (msg.type === "searchKeyword") {
            if (!map) {
              setStatus("지도 준비 안 됨: 검색 처리 불가", true);
              return;
            }
            const ps = new kakao.maps.services.Places();
            ps.keywordSearch(msg.keyword, (data, status) => {
              if (status === kakao.maps.services.Status.OK) {
                const first = data[0];
                map.setCenter(new kakao.maps.LatLng(first.y, first.x));
                new kakao.maps.Marker({
                  position: new kakao.maps.LatLng(first.y, first.x),
                  map: map,
                });
                sendToRN({
                  type: "searchResult",
                  name: first.place_name,
                  address: first.address_name,
                  location: { lat: first.y, lng: first.x },
                });
                setStatus(`검색: ${first.place_name} (${first.address_name})`);
              } else {
                sendToRN({ type: "searchResult", error: status });
                setStatus(`검색 실패: ${status}`, true);
              }
            });
          }
        } catch (err) {
          console.warn("파싱 실패", err);
        }
      }

      function getQueryParam(key) {
        const params = new URLSearchParams(window.location.search);
        return params.get(key);
      }

      window.addEventListener("load", () => {
        waitForKakaoAndInit();
        window.addEventListener("message", handleMessageEvent);

        // 디버그: ?q=강남역 처럼 붙이면 자동 검색 시도
        const q = getQueryParam("q");
        if (q) {
          const fakeEvent = {
            data: JSON.stringify({ type: "searchKeyword", keyword: q }),
          };
          handleMessageEvent(fakeEvent);
        }
      });
    </script>
  </body>
</html>
