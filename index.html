<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>카카오맵 WebView 연동</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      let map;
      let volunteerMarkers = [];
      let courseMarkers = [];
      let coursePolyline = null;

      // 전국 중앙(대충)과 넓은 줌 레벨로 초기화
      // level 값이 클수록 더 멀리(넓게) 보입니다.
      function initMap(lat = 36.5, lng = 127.9, zoom = 12) {
        if (typeof kakao === "undefined" || !kakao.maps) {
          console.error("카카오 객체 없음. 도메인/키 설정을 확인해라.");
          return;
        }

        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(lat, lng),
          level: zoom,
        };
        map = new kakao.maps.Map(container, options);

        sendToRN({ type: "map_loaded" });
      }

      function clearMarkers(arr) {
        arr.forEach((m) => m.setMap(null));
        arr.length = 0;
      }

      function clearCourse() {
        clearMarkers(courseMarkers);
        if (coursePolyline) {
          coursePolyline.setMap(null);
          coursePolyline = null;
        }
      }

      function waitForKakaoAndInit() {
        const maxTries = 30;
        let tries = 0;

        const iv = setInterval(() => {
          if (typeof kakao !== "undefined" && kakao.maps) {
            clearInterval(iv);
            initMap();
          } else if (++tries >= maxTries) {
            clearInterval(iv);
            console.error("카카오맵 SDK 로드 실패");
          }
        }, 200);
      }

      function sendToRN(payload) {
        if (
          window.ReactNativeWebView &&
          window.ReactNativeWebView.postMessage
        ) {
          window.ReactNativeWebView.postMessage(JSON.stringify(payload));
        } else {
          window.parent.postMessage(JSON.stringify(payload), "*");
        }
      }

      function addCourseMarker(lat, lng) {
        const pos = new kakao.maps.LatLng(Number(lat), Number(lng));
        const marker = new kakao.maps.Marker({ position: pos, map });
        courseMarkers.push(marker);
        return pos;
      }

      function handleMessageEvent(e) {
        try {
          const msg = JSON.parse(e.data);

          if (!map) {
            console.warn("지도가 아직 준비되지 않음");
            return;
          }

          // 코스 마커 + 폴리라인
          if (msg.type === "setCourse" && Array.isArray(msg.stops)) {
            clearCourse();

            const ps = new kakao.maps.services.Places();
            const path = [];
            const bounds = new kakao.maps.LatLngBounds();
            let idx = 0;

            function next() {
              if (idx >= msg.stops.length) {
                if (path.length > 1) {
                  coursePolyline = new kakao.maps.Polyline({
                    path,
                    strokeWeight: 4,
                    strokeColor: "#3B82F6",
                    strokeOpacity: 0.9,
                    strokeStyle: "solid",
                  });
                  coursePolyline.setMap(map);
                }
                if (!bounds.isEmpty()) {
                  map.setBounds(bounds);
                }
                return;
              }

              const stop = msg.stops[idx++];

              // 위경도 직접 전달 시 바로 사용
              if (stop && stop.lat && stop.lng) {
                const pos = addCourseMarker(Number(stop.lat), Number(stop.lng));
                path.push(pos);
                bounds.extend(pos);
                next();
                return;
              }

              // 키워드/이름으로 검색
              const keyword = (stop && (stop.keyword || stop.name)) || "";
              if (!keyword) {
                next();
                return;
              }

              ps.keywordSearch(
                keyword,
                (data, status) => {
                  if (status === kakao.maps.services.Status.OK && data.length) {
                    const first = data[0];
                    const lat = Number(first.y);
                    const lng = Number(first.x);
                    const pos = addCourseMarker(lat, lng);
                    path.push(pos);
                    bounds.extend(pos);
                  }
                  next();
                },
                { size: 3 }
              );
            }

            next();
            return;
          }

          if (msg.type === "clearCourse") {
            clearCourse();
            return;
          }

          if (msg.type === "setVolunteerLocations") {
            // 기존 봉사 마커 제거
            clearMarkers(volunteerMarkers);

            // 새 마커 생성 (봉사 포인트는 필요 시에만 RN에서 보냄)
            (msg.locations || []).forEach((loc) => {
              const position = new kakao.maps.LatLng(loc.lat, loc.lng);
              const marker = new kakao.maps.Marker({
                position: position,
                map: map,
                title: loc.name,
              });

              kakao.maps.event.addListener(marker, "click", function () {
                sendToRN({
                  type: "location_selected",
                  location: loc,
                });
              });

              volunteerMarkers.push(marker);
            });
            return;
          }

          if (msg.type === "setDistrictOffices") {
            // 구청 포커싱만 원하므로, 마커는 생성하지 않고 무시
            return;
          }

          if (msg.type === "setLocation") {
            // 포커싱만 하고 마커는 생성하지 않음
            const position = new kakao.maps.LatLng(msg.lat, msg.lng);
            map.setCenter(position);
            if (msg.zoom != null) {
              map.setLevel(msg.zoom);
            }
            return;
          }

          if (msg.type === "setCurrentLocation") {
            // 현재 위치로 포커싱만
            const position = new kakao.maps.LatLng(msg.lat, msg.lng);
            map.setCenter(position);
            if (msg.zoom != null) {
              map.setLevel(msg.zoom);
            }
            return;
          }

          if (msg.type === "searchKeyword") {
            const ps = new kakao.maps.services.Places();
            ps.keywordSearch(msg.keyword, (data, status) => {
              if (status === kakao.maps.services.Status.OK) {
                const first = data[0];
                const lat = Number(first.y);
                const lng = Number(first.x);
                map.setCenter(new kakao.maps.LatLng(lat, lng));
                // 검색 시에도 마커를 찍지 않으려면 아래 코드를 제거 유지
                // new kakao.maps.Marker({ position: new kakao.maps.LatLng(lat, lng), map: map });

                sendToRN({
                  type: "searchResult",
                  name: first.place_name,
                  address: first.address_name,
                  location: { lat, lng },
                });
              } else {
                sendToRN({ type: "searchResult", error: status });
              }
            });
            return;
          }
        } catch (err) {
          console.warn("메시지 파싱 실패", err);
        }
      }

      window.addEventListener("load", () => {
        waitForKakaoAndInit();
        window.addEventListener("message", handleMessageEvent);
      });
    </script>

    <!-- 카카오맵 JS 키 -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=98ccef4d83216d7a4ddf544aea39d6eb&libraries=services,clusterer"></script>
  </body>
</html>