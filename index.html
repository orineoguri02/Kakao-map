<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>카카오맵 WebView 연동</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      #map {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      let map;
      let volunteerMarkers = [];
      let selectedMarker = null;

      function initMap() {
        map = new kakao.maps.Map(document.getElementById("map"), {
          center: new kakao.maps.LatLng(35.1796, 129.0756),
          level: 8,
        });
        // RN 쪽에 로드 완료 알림
        window.ReactNativeWebView?.postMessage(
          JSON.stringify({ type: "map_loaded" })
        );
      }

      function clearMarkers(arr) {
        arr.forEach((m) => m.setMap(null));
        arr.length = 0;
      }

      function handleMessage(e) {
        const msg = JSON.parse(e.data);
        if (msg.type === "setVolunteerLocations") {
          clearMarkers(volunteerMarkers);
          msg.locations.forEach((loc) => {
            const marker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(loc.lat, loc.lng),
              map: map,
            });
            volunteerMarkers.push(marker);
          });
        }
        if (msg.type === "setLocation") {
          // 기존 선택 마커 제거
          if (selectedMarker) selectedMarker.setMap(null);
          selectedMarker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(msg.lat, msg.lng),
            map: map,
          });
          map.setCenter(new kakao.maps.LatLng(msg.lat, msg.lng));
          if (msg.zoom != null) map.setLevel(msg.zoom);
        }
      }

      window.addEventListener("message", handleMessage);

      window.onload = () => {
        const script = document.createElement("script");
        script.src =
          "https://dapi.kakao.com/v2/maps/sdk.js?appkey=14c064ab4043e357b8a6246384ef402a";
        script.onload = initMap;
        document.head.appendChild(script);
      };
    </script>
  </body>
</html>
